% Copyright 2021 Google LLC
%
% Use of this source code is governed by an MIT-style
% license that can be found in the LICENSE file or at
% https://opensource.org/licenses/MIT.
\begin{tikzpicture}
  [line width=0.6,
   box/.style = {
     draw, rectangle, rounded corners
   },
   wire/.style = {
     ->,rounded corners=1.5pt
   },
   cbox/.style={
     rectangle,
     thick,
     draw,
     minimum height=1cm,
     text centered,
     anchor=center,
     rounded corners=2pt,
   },
   minimum size=0.5cm,
   x=1.5cm, y=1.5cm
  ]
  %Draw nodes
  \node[rectangle] at (0,0) (M) {$M$};
  \node[rectangle] at (3,0) (N) {$N$};
  \node[cbox] at (1,-1) (H1) {$H_h$};
  \node[XOR] at (M |- H1) (X1) {};
  \node[cbox] at (0,-3) (E) {$E_K$};
  \node[rectangle] at (4,-3) (T) {$T$};
  \node[XOR] at (0.75, -3) (XS) {};
  \node[cbox] at (2,-3) (CTR) {$\XCTR_K$};
  \node[XOR] at (N |- CTR) (X2) {};
  \node[cbox] at (1,-5) (H3) {$H_h$};
  \node[XOR] at (M |- H3) (X3) {};
  \node[rectangle] at (0,-6) (C) {$Y$};
  \node[rectangle] at (X2 |- C) (D) {$Z$};
  \draw[wire] (M) -- (X1);
  \draw[wire] (N) -- (X2);
  \draw[wire] ([yshift=-1ex] X2 |- H1) -- ([yshift=-1ex] H1.east);
  \draw[wire] (H1) -- (X1);
  \draw[wire] (X1) -- node[left] {\(\MM\)} (E);
  \draw[wire] (0,-2) -| (XS);
  \draw[wire] (XS) -- node[above] {\(S\)} (CTR);
  \draw[wire] (CTR) -- (X2);
  \draw[wire] (0,-4) -| (XS);
  \draw[wire] (E) -- node[left] {\(\YY\)} (X3);
  \draw[wire] (T) -- ++(-0.5, 0) |- ([yshift=+1ex] H1.east);
  \draw[wire] (T) -- ++(-0.5, 0) |- ([yshift=+1ex] H3.east);
  \draw[wire] ([yshift=-1ex] X2 |- H3) -- ([yshift=-1ex] H3.east);
  \draw[wire] (H3) -- (X3);
  \draw[wire] (X3) -- (C);
  \draw[wire] (X2) -- (D);
\end{tikzpicture}
